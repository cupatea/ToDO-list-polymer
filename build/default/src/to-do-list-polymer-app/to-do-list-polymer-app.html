<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

</head><body><dom-module id="to-do-list-polymer-app">
  <template>
    <style>
      :host {
        display: block;
      }
      .container{
        margin: auto;
        width: 50%;
        padding: 10px;
      }
      .form {
        display: flex;
        width: 80%;
        margin-left: 26px;
        margin-bottom: 30px;
      }
      .form paper-input {
        --paper-input-container-color: black;
        --paper-input-container-focus-color: red;
        flex:1;
        margin-right: 30px;
      }

      paper-item{
        --paper-item-selected-weight:regular;
      }

      .right_button {
        position: absolute;
        right: 118px;
        top: 3px;
        color: #616161;
      }
      .left_button {
        display:felx;
        color: #616161;
      }
      .form paper-icon-button {
        align-self:  center;
        color: #616161;
        display:flex;
      }

    </style>
    <div class="container">
      <div class="form">

        <paper-input always-float-label="" label="Enter your task here:" value="{{task.name}}" char-counter="" maxlength="50"></paper-input>

        <paper-icon-button icon="add" on-tap="_addTask"></paper-icon-button>

        <iron-a11y-keys target="[[target]]" keys="enter" on-keys-pressed="_addTask"></iron-a11y-keys>
      </div>

      <div class="todo">
        <paper-listbox>
          <template is="dom-repeat" items="{{ tasks }}">
            <paper-item>

              <paper-icon-button class="left_button" icon="radio-button-unchecked" on-tap="_completeTask"></paper-icon-button>

              {{item.name}}

              <paper-icon-button class="right_button" icon="cancel" on-tap="_deleteTask"></paper-icon-button>

            </paper-item>
          </template>
        </paper-listbox>
      </div>

      <div class="completed">
        <paper-listbox>
          <template is="dom-repeat" items="{{ completions }}">
            <paper-item>

              <paper-icon-button class="left_button" icon="check-circle" on-tap="_unCompleteTask"></paper-icon-button>

              {{item.name}}

              <paper-icon-button class="right_button" icon="cancel" on-tap="_deleteCompletion"></paper-icon-button>

            </paper-item>
          </template>
        </paper-listbox>
      </div>
    </div>

    <!-- <iron-localstorage name="tasks"
      value="{{tasks}}"
      on-iron-localstorage-load-empty="initializeEmptyTasks"
    ></iron-localstorage>

    <iron-localstorage name="completions"
      value="{{completions}}"
      on-iron-localstorage-load-empty="initializeEmptyCompletions"
    ></iron-localstorage> -->
    <iron-ajax id="getTasks" auto="" url="{{url}}" params="{&quot;todo&quot;:&quot;true&quot;}" handle-as="json" last-response="{{tasks}}"></iron-ajax>

    <iron-ajax id="getCompletions" auto="" url="{{url}}" params="{&quot;completed&quot;:&quot;true&quot;}" handle-as="json" last-response="{{completions}}"></iron-ajax>

    <iron-ajax id="postTask" method="POST" url="{{url}}" content-type="application/json" handle-as="json" body="{{task}}" on-response="_generateRequest"></iron-ajax>

    <iron-ajax id="deleteTask" method="DELETE" url="{{temp_url}}" handle-as="json" on-response="_generateRequest"></iron-ajax>

    <iron-ajax id="updateTask" method="PATCH" url="{{temp_url}}" content-type="application/json" handle-as="json" body="{{task}}" on-response="_generateRequest"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'to-do-list-polymer-app',

      properties: {
        task: {
          type: Object,
          value: function(){
            return {};
          }
        },
        url: {
          type: String,
          value: function(){
            return "https://to-do-list-rails-server.herokuapp.com/tasks";
          }
        },
        temp_url:{
          type: String,
          value: function(){
            return "";
          }
        },
        tasks: {
          type: Array,
          value:function(){
            return [];
          }
        },
        completions: {
          type: Array,
          value:function(){
            return [];
          }
        }
      },

      _addTask: function() {
        if(this.task.name) {this.$.postTask.generateRequest();}
        this.task = {};
      },

      _deleteTask: function(e) {
        var index = this.tasks.indexOf(e.model.get('item'));
        this.temp_url = this.url + "/" + this.tasks[index].id;
        this.$.deleteTask.generateRequest();
      },

      _deleteCompletion: function(e) {
        var index = this.completions.indexOf(e.model.get('item'));
        this.temp_url = this.url + "/" + this.completions[index].id;
        this.$.deleteTask.generateRequest();
      },

      _completeTask: function(e){
        var index = this.tasks.indexOf(e.model.get('item'));
        this.task = this.tasks[index];
        this.task.completed = true;
        this.temp_url = this.url + "/" + this.task.id;
        this.$.updateTask.generateRequest();
        this.task = {};
      },

      _unCompleteTask: function(e){
        var index = this.completions.indexOf(e.model.get('item'));
        this.task = this.completions[index];
        this.task.completed = false;
        this.temp_url = this.url + "/" + this.task.id;
        this.$.updateTask.generateRequest();
        this.task = {};
      },
      _generateRequest: function(){
        this.$.getTasks.generateRequest();
        this.$.getCompletions.generateRequest();
      }

      // initializeEmptyTasks: function(){
      //   this.tasks = [];
      // },
      //
      // initializeEmptyCompletions: function(){
      //   this.completions = [];
      // }
    });
  </script>
</dom-module>
</body></html>